<!DOCTYPE html>
<html>
<head>
    <title>pref.js surveyer</title>

<style type="text/css"><!-- /* --><![CDATA[ /* */
#output table { border-collapse: collapse; font-size: x-small; overflow: auto; }
#output table td { border: 1px solid #ddd; padding: 1px; vertical-align: top; word-wrap: break-word; overflow-wrap: break-word; }
#output table tr:hover { background-color: #eee; }
#output table td.json, #output table td.uri, #output table td.dump { word-break: break-all; }
#output table td.undefined { color: #888; font-style: italic; }
#output table tr.sameval td:first-child { color: #444; }
#output table tr.newkey  td:first-child { text-decoration: underline;    }
#output table tr.oldkey  td:first-child { text-decoration: line-through; }
/* ]]><!-- */ --></style>

<script type="text/javascript" defer="defer" async="async"><!-- /* --><![CDATA[ /* *///
var PrefJS = function() {return this.initialize.apply(this, arguments);};
PrefJS.prototype = {
    data: null,
    initialize: function() {
        this.data = [];
    },
    pref: function(key, val) {
        this.data[key] = val;
    },
    loadJS: function(script) {
        var scriptFunc = new Function("pref", "user_pref", "sticky_pref", script);
        var prefFunc = this.pref.bind(this);
        scriptFunc.call(this, prefFunc, prefFunc, prefFunc);
    },
    get: function(key) {
        return this.data[key];
    },
    getKeies: function() {
        var keies = [];
        for (var key in this.data) {
            keies.push(key);
        }
        return keies;
    },

    dummy: null
};

var PrefJSMan = function() {return this.initialize.apply(this, arguments);};
PrefJSMan.prototype = {
    sideA: null,
    sideB: null,
    initialize: function() {
        this.sideA = new PrefJS();
        this.sideB = new PrefJS();
    },
    getSideData: function(side) {
        if (side == "a") {
            return this.sideA;
        } else if (side == "b") {
            return this.sideB;
        } else {
            throw new Error("Wrong side");
        }
    },
    getKeies: function() {
        var keies = [];
        var akeies = this.sideA.getKeies();
        var bkeies = this.sideB.getKeies();

        for (var i = 0; i < akeies.length; i++) {
            var key = akeies[i];
            if (keies.indexOf(key) < 0) {
                keies.push(key);
            }
        }
        for (var i = 0; i < bkeies.length; i++) {
            var key = bkeies[i];
            if (keies.indexOf(key) < 0) {
                keies.push(key);
            }
        }

        return keies;
    },
    getCompareData: function() {
        var keies = this.getKeies().sort();
        var data = [];

        for (var i = 0; i < keies.length; i++) {
            var d = {
                name: keies[i],
                data: [
                    this.sideA.get(keies[i]),
                    this.sideB.get(keies[i])
                ]
            };
            data.push(d);
        }
        return data;
    },
    capture: function(text, side) {
        this.getSideData(side).loadJS(text);
    },
    dummy: null
};

var gPrefJSMan = new PrefJSMan();
window.addEventListener("load", function() {
    document.getElementById("capture_now").addEventListener("click", function() {
        var oText = document.getElementById("script_text");
        var oSideB = document.getElementById("capture_side_b");
        var side = (oSideB.checked)? "b" : "a";
 
        gPrefJSMan.capture(oText.value, side);
    }, false);

    document.getElementById("survey_now").addEventListener("click", function() {
        var compData = gPrefJSMan.getCompareData();
        var oOutput = document.getElementById("output");
        oOutput.innerHTML = "";

        var oTable = document.createElement("table");

        for (var i = 0; i < compData.length; i++) {
            var c = compData[i];

            var row = oTable.insertRow(-1);
            var name = row.insertCell(-1);
            var valA = row.insertCell(-1);
            var valB = row.insertCell(-1);

            name.appendChild(document.createTextNode(c.name));
            valA.appendChild(document.createTextNode(c.data[0]));
            valB.appendChild(document.createTextNode(c.data[1]));

            var valAclassList = [];
            var valBclassList = [];
            // undefined
            if (c.data[0] == undefined) valAclassList.push("undefined");
            if (c.data[1] == undefined) valBclassList.push("undefined");
            // json
            try {
              var d = JSON.parse(c.data[0]);
              if (typeof(d) == "object") { valAclassList.push("json"); }
            } catch (ex) {}
            try {
              var d = JSON.parse(c.data[1]);
              if (typeof(d) == "object") { valBclassList.push("json"); }
            } catch (ex) {}
            // uri
            if (/^(https?|ftp|mailto|file|news|tv|tel|urn|data|jar|about|chrome):/.test(c.data[0])) valAclassList.push("uri");
            if (/^(https?|ftp|mailto|file|news|tv|tel|urn|data|jar|about|chrome):/.test(c.data[1])) valBclassList.push("uri");

            if (valAclassList.length > 0) valA.setAttribute("class", valAclassList.join(" "));
            if (valBclassList.length > 0) valB.setAttribute("class", valBclassList.join(" "));

            // fix format
            name.innerHTML = name.innerHTML.replace(/([\.,;:_]+)/g, "$1<wbr />");
            if (!valA.hasAttribute("class")) {
              valA.innerHTML = valA.innerHTML.replace(/([\.,;:_]+)\b/g, "$1<wbr />");
            }
            if (!valB.hasAttribute("class")) {
              valB.innerHTML = valB.innerHTML.replace(/([\.,;:_]+)\b/g, "$1<wbr />");
            }

            if (c.data[0] == c.data[1]) {
                row.setAttribute("class", "sameval");
            } else if (c.data[0] === undefined && c.data[1] !== undefined) {
                row.setAttribute("class", "newkey");
            } else if (c.data[0] !== undefined && c.data[1] === undefined) {
                row.setAttribute("class", "oldkey");
            }
        }

        // remove sameval
        var samevalrows = oTable.getElementsByClassName("sameval");
        for (var i = samevalrows.length - 1; i >= 0; i--) {
            var row = samevalrows[i];
            row.parentNode.removeChild(row);
        }

        oOutput.appendChild(oTable);
    }, false);
    document.getElementById("get_xhtml_source").addEventListener("click", function() {
        var oOutput = document.getElementById("output");
        var html = "";
        if (XMLSerializer) {
            html = (new XMLSerializer()).serializeToString(oOutput);
        } else {
            html = oOutput.outerHTML || oOutput.innerHTML;
        }
        prompt("", html);
        
    }, false);

    // drag and drop
    document.getElementById("script_text").addEventListener("dragover", function (event) {
        try {
            if (event.dataTransfer.types.contains("Files")) {
                event.stopPropagation();
                event.preventDefault();
                event.dataTransfer.dropEffect = "copy";
            }
        } catch (ex) {
            if (console && console.error) { console.error(ex); }
        }
    }, false);
    document.getElementById("script_text").addEventListener("drop", function (event) {
        try {
            if (event.dataTransfer.types.contains("Files")) {
                event.stopPropagation();
                event.preventDefault();

                if (event.dataTransfer.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById("script_text").value = e.target.result;
                    };
                    reader.readAsText(event.dataTransfer.files[0]);
                }
            }
        } catch (ex) {
            if (console && console.error) { console.error(ex); }
        }
    }, false);
}, false);
// ]]><!-- --></script>

</head>
<body>

<fieldset>
<legend>Capture pref.js data</legend>
<textarea id="script_text" rows="5" style="width: 100%; resize: vertical;"></textarea>
<div>
<input type="button" id="capture_now" value="Capture above code" />
to
<input type="radio" value="a" name="capture_side" id="capture_side_a" />
<label for="capture_side_a">A</label>
<input type="radio" value="b" name="capture_side" id="capture_side_b" />
<label for="capture_side_b">B</label>
</div>
</fieldset>
<fieldset>
<legend>Survey</legend>
<input type="button" id="survey_now" value="Survey" />
<input type="button" id="get_xhtml_source" value="Get XHTML source" />
<output id="output"></output>
</fieldset>

</body>
</html>
